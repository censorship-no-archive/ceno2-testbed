---

- name: Create dCDN user
  user:
    name: dcdn
    comment: dCDN test user

- name: Install dependencies of dCDN service
  apt: pkg={{item}} state=installed
  with_items:
    - git
    - automake
    - libtool
    - make
    - g++
    - clang
    - libc++-dev
    - libblocksruntime-dev
    - iptables

- name: Fetch dCDN source via Git
  git:
    repo: https://github.com/inetic/dcdn
    dest: /home/dcdn/dcdn-git
    version: f97284bca415cc012fff0e94d420fc2dde8cc307
  notify:
    - Restart dCDN client

- name: Build dCDN
  command: ./build.sh
  args:
    chdir: /home/dcdn/dcdn-git

- name: Install dCDN client service
  template:
    src: dcdn-client.service.j2
    dest: /etc/systemd/system/dcdn-client.service
    owner: root
    group: root
    mode: 0644

- name: Enable dCDN client service
  service: name=dcdn-client enabled=true
  when: not dormant
  notify:
    - Restart dCDN client

- name: Disable and stop dCDN client service on a dormant testbed
  service: name=dcdn-client enabled=false state=stopped
  when: dormant
