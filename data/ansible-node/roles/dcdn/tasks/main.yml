---

- name: Create dCDN user
  user:
    name: dcdn
    comment: dCDN test user

- name: Install dependencies of dCDN service
  apt: pkg={{item}} state=installed
  with_items:
    - git
    - automake
    - libtool
    - make
    - g++
    - clang
    - libc++-dev
    - libblocksruntime-dev
    - iptables

- name: Fetch dCDN source via Git
  git:
    repo: https://github.com/inetic/dcdn
    dest: /home/dcdn/dcdn-git
    version: 011a07d1a78f9ae85d836cd981783bfe65f8031b
    force: yes
  register: dcdngit

- name: Check if dCDN client binary is present
  stat: path=/home/dcdn/dcdn-git/client
  register: dcdncli
  ignore_errors: True

- name: Build dCDN
  command: ./build.sh
  args:
    chdir: /home/dcdn/dcdn-git
  when: "(dcdncli | failed) or dcdngit.changed"
  notify:
    - Restart dCDN client

- name: Install dCDN client service
  template:
    src: dcdn-client.service.j2
    dest: /etc/systemd/system/dcdn-client.service
    owner: root
    group: root
    mode: 0644

- name: Enable dCDN client service
  service: name=dcdn-client enabled=true
  when: not dormant
  notify:
    - Restart dCDN client

- name: Disable and stop dCDN client service on a dormant testbed
  service: name=dcdn-client enabled=false state=stopped
  when: dormant

- name: Set daily Cron task for cleanup of dCDN cached files
  copy: src=op-dcdn-cache-cleanup.cron-daily dest=/etc/cron.daily/op-dcdn-cache-cleanup owner=root group=root mode=0755
