#!/bin/sh
# Inject "connectTo" blocks into cjdns's (possibly autogenerated)
# configuration file.  It drops comments and leaves a pure JSON file.
#
# Requires ``cjdroute`` and ``jq``.

set -e

CONF_DIR=/usr/local/etc
PART4_PATH="$CONF_DIR/cjdns-client-connectto4.json"
PART6_PATH="$CONF_DIR/cjdns-client-connectto6.json"

CJD_CONF=/etc/cjdroute.conf
CJD_CONF_NEW=$(mktemp)

# More than four hours to get the right filter expression, not bad. https://imgs.be/59165b3f-f3f.png
cjdroute --cleanconf < "$CJD_CONF" \
    | jq --argfile conn4 "$PART4_PATH" \
         --argfile conn6 "$PART6_PATH" \
         '.interfaces.UDPInterface |= map(.+{connectTo:(if .bind|contains("[") then $conn6 else $conn4 end)})' \
         > "$CJD_CONF_NEW"

cp "$CJD_CONF" "$(mktemp /tmp/cjdroute-backup.XXXX)"
sudo tee "$CJD_CONF" < "$CJD_CONF_NEW" > /dev/null  # overwrite in place
rm "$CJD_CONF_NEW"
